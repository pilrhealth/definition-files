{
  "code": "custom_report",
  "version": 1,
  "name": "CBTgsh Reports",
  "description": "Custom reports for CBTgsh",
  "definition_type": "tool",
  "customizations": {
    "package": "com.pilrhealth.tools.custom_report",
    "classnamePrefix": "CustomReport",
    "apix": true,
    "controllers": {
      "coordinate": "CustomReport"
    }
  },
  "reports": [
    {
      "code": "meal_log",
      "dataset": "pilrhealth:mobile:survey_data",
      "columns": [
        { "key": "meal_date", "label": "Date/Time" },
        { "key": "meal_skip", "label": "Skip?" },
        { "key": "meal_type", "label": "Meal Type" },
        { "key": "meal_food", "label": "Food" },
        { "key": "meal_drink", "label": "Drink" },
        { "key": "meal_location", "label": "Location" },
        { "key": "meal_feeling_text", "label": "Feelings" },
        { "key": "meal_behaviors", "label": "Behaviors" },
        { "key": "meal_thoughts", "label": "Thoughts/Notes" }
      ],
      "query": "[{\"$match\":{\"$or\":[{\"data.response\":{\"$exists\":1,\"$ne\":\"\"}},{\"data.responses\":{\"$exists\":1,\"$ne\":[]}}],\"data.question_code\":{\"$options\":\"\",\"$regex\":\"^meal\"},\"data.survey_code\":\"meal_log\",\"localTimestamp\":{\"$gte\":\"{{start_date}}\",\"$lt\":\"{{end_date}}\"},\"metadata.pt\":\"{{pt}}\"}},{\"$group\":{\"_id\":{\"session\":\"$data.session\",\"x\":{}},\"fields\":{\"$push\":{\"key\":\"$data.question_code\",\"value\":{\"$cond\":[\"$data.response\",\"$data.response\",\"$data.responses\"]}}}}}]"
    },
    {
      "code": "daily_eating_bodycheck",
      "dataset": "pilrhealth:mobile:survey_data",
      "columns": [
        { "key": "section", "label": "Section" },
        { "key": "card", "label": "Question" },
        { "key": 2, "label": "M" },
        { "key": 3, "label": "T" },
        { "key": 4, "label": "W" },
        { "key": 5, "label": "Th" },
        { "key": 6, "label": "F" },
        { "key": 7, "label": "Sa" },
        { "key": 1, "label": "Su" },
      ],
      "query": "[{\"$match\":{\"localTimestamp\":{\"$gte\":\"{{start_date}}\",\"$lt\":\"{{end_date}}\"},\"metadata.pt\":\"{{pt}}\",\"data.survey_code\":\"daily_eating_bodycheck\",\"data.question_code\":{\"$regex\":\"daily\"},\"$or\":[{\"data.response\":{\"$exists\":1,\"$ne\":\"\"}},{\"data.responses\":{\"$exists\":1,\"$ne\":[]}}]}},{\"$project\":{\"data\":1,\"localTimestamp\":1,\"section\":{\"$cond\":[{\"$setIsSubset\":[[\"$data.question_code\"],[\"daily_times\",\"daily_binge\",\"daily_vomit\",\"daily_laxative\",\"daily_diuretics\",\"daily_meds\"]]},\"Eating Behaviors\",{\"$cond\":[{\"$setIsSubset\":[[\"$data.question_code\"],[\"daily_skip\",\"daily_skipbreak\",\"daily_skipsnack1\",\"daily_skiplun\",\"daily_skipsnack2\",\"daily_skipdin\",\"daily_skipsnack3\",\"daily_calor\"]]},\"Meal Patterns\",{\"$cond\":[{\"$setIsSubset\":[[\"$data.question_code\"],[\"daily_bodycheck\"]]},\"Body Checking\",{\"$cond\":[{\"$setIsSubset\":[[\"$data.question_code\"],[\"daily_emo\",\"daily_sad\",\"daily_lonely\",\"daily_excited\",\"daily_ashamed\",\"daily_proud\"]]},\"Emotions\",{\"$cond\":[{\"$setIsSubset\":[[\"$data.question_code\"],[\"daily_angry\",\"daily_distress\",\"daily_confident\",\"daily_energetic\",\"daily_happy\"]]},\"Emotions\",\"Unknown\"]}]}]}]}]}}},{\"$group\":{\"_id\":\"$data.question_code\",\"section\":{\"$first\":\"$section\"},\"fields\":{\"$push\":{\"key\":{\"$dayOfWeek\":\"$localTimestamp\"},\"value\":\"$data.response_value\"}}}},{\"$sort\":{\"section\":1}},{\"$project\":{\"fields\":{\"$concatArrays\":[\"$fields\",[{\"key\":{\"$literal\":\"card\"},\"value\":\"$_id\"},{\"key\":{\"$literal\":\"section\"},\"value\":\"$section\"}]]}}}]"

    },
    {
      "code": "bodycheck_log",
      "dataset": "pilrhealth:mobile:survey_data",
      "columns": [
        { "key": "body_date", "label": "Date/Time" },
        { "key": "body_check", "label": "Body Check Behaviors" },
        { "key": "body_check_text", "label": "Body Check Behaviors Text" },
        { "key": "body_times", "label": "Times Checked since last log" },
        { "key": "body_location", "label": "Location(s)" },
        { "key": "body_location_text", "label": "Location(s)" },
        { "key": "body_feeling", "label": "Feelings" },
        { "key": "body_feeling_text", "label": "Feelings" },
        { "key": "body_thoughts", "label": "Notes" }
      ],
      "query": "[{\"$match\":{\"data.question_code\":{\"$regex\":\"body\"},\"data.survey_code\":\"bodycheck_log\",\"localTimestamp\":{\"$gte\":\"{{start_date}}\",\"$lt\":\"{{end_date}}\"},\"metadata.pt\":\"{{pt}}\"}},{\"$group\":{\"_id\":\"$data.session\",\"fields\":{\"$push\":{\"key\":\"$data.question_code\",\"value\":{\"$cond\":[\"$data.response\",\"$data.response\",\"$data.responses\"]}}}}}]"

    }
  ]
}
